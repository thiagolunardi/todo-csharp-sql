name: deploy
run-name: Deploy ${{ github.repository }} to ${{ inputs.environment}} by ${{ github.actor }}

on:  
  workflow_call:
    inputs:
      version: 
        required: true
        type: string
      environment:
        required: true
        type: string

jobs:
  deploy-to-azure:
    name: Azure
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
    - name: Validate environment input
      run: |
        if [[ "${{ inputs.environment }}" != "Production" && "${{ inputs.environment }}" != "Staging" ]]; then
          echo "Invalid environment: ${{ inputs.environment }}. Allowed values are 'Production' or 'Staging'."
          exit 1
        fi

    - name: Deploy Docker to Azure
      id: deploy-docker-to-azure
      uses: azure/webapps-deploy@v3
      with:        
        app-name: ${{ vars.AZURE_WEBAPP_NAME }}
        resource-group-name: ${{ vars.AZURE_RESOURCE_GROUP }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        images: '${{ vars.DOCKER_CONTAINER_REGISTRY }}/${{ github.repository }}:${{ inputs.version }}'

    - name: Set container version ${{ inputs.version }}
      run: az webapp config appsettings set --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} --name ${{ vars.AZURE_WEBAPP_NAME }} --settings MY_APP_VERSION="${{ inputs.version }}"
